name: CI Pipeline

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  test-purchase:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          pip install -r services/purchase/requirements.txt
          pip install pytest
      - name: Run Tests
        env:
          SECRET_KEY: test-key
          DEBUG: True
        run: |
          cd services/purchase
          pytest

  test-inventory:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          pip install -r services/inventory/requirements.txt
          pip install pytest
      - name: Run Tests
        env:
          SECRET_KEY: test-key
          DEBUG: True
        run: |
          cd services/inventory
          pytest

  test-pos:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          pip install -r services/pos/requirements.txt
          pip install pytest pytest-django
      - name: Run Tests
        env:
          SECRET_KEY: test-key
          DEBUG: True
        run: |
          cd services/pos
          pytest

  test-product:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          pip install -r services/product/requirements.txt
          pip install pytest pytest-django
      - name: Run Tests
        env:
          SECRET_KEY: test-key
          DEBUG: True
        run: |
          cd services/product
          pytest

  test-company:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          pip install -r services/company/requirements.txt
          pip install pytest pytest-django
      - name: Run Tests
        env:
          SECRET_KEY: test-key
          DEBUG: True
        run: |
          cd services/company
          pytest

  test-auth:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Dependencies
        run: |
          pip install -r services/auth/requirements.txt
          pip install pytest pytest-django
      - name: Run Tests
        env:
          SECRET_KEY: test-key
          DEBUG: True
        run: |
          cd services/auth
          pytest

  build-images:
    needs:
      [
        test-purchase,
        test-inventory,
        test-pos,
        test-product,
        test-company,
        test-auth,
      ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Purchase Image
        run: docker build -t purchase-service services/purchase
      - name: Build Inventory Image
        run: docker build -t inventory-service services/inventory
