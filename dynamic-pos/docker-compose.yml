services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: dynamicpos-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - backend

  redis:
    image: redis:7-alpine
    container_name: dynamicpos-redis
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - backend

  kong:
    image: kong:3.0
    container_name: dynamicpos-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    volumes:
      - ./kong.yml:/kong/kong.yml:ro
    ports:
      - "8101:8000"   # তুই এটা দিয়ে access করবি
      - "8102:8001"
    networks:
      - backend          # এটা যোগ কর
    depends_on:
      - company
      - auth


  postgres_auth:
    image: postgres:15
    container_name: dynamicpos-postgres-auth
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
      - "5437:5432"
    volumes:
      - pgdata_auth:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d authdb"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - backend

  postgres_company:
    image: postgres:15
    container_name: dynamicpos-postgres-company
    environment:
      POSTGRES_DB: companydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
      - "5438:5432"
    volumes:
      - pgdata_company:/var/lib/postgresql/data
    healthcheck:                     # <-- এটা missing ছিল, এখন আছে
      test: ["CMD-SHELL", "pg_isready -U postgres -d companydb"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - backend

  postgres_product:
    image: postgres:15
    container_name: dynamicpos-postgres-product
    environment:
      POSTGRES_DB: productdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
      - "5439:5432"
    volumes:
      - pgdata_product:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d productdb"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - backend

  auth:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: dynamicpos-auth
    depends_on:
      postgres_auth:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SECRET_KEY: "django-insecure-nhyxuqdm3u33619f656b0q8huk2pvewo4jr7t8"
      DATABASE_URL: postgres://postgres:01713447728@postgres_auth:5432/authdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      REDIS_URL: redis://redis:6379/0
      DEBUG: "True"
      ALLOWED_HOSTS: "*"
      JWT_ALGORITHM: "RS256"
      JWT_ISSUER: "auth-service"
      JWT_AUDIENCE: "pos-system"
    env_file:
      - ./services/auth/.env
    ports:
      - "8100:8000"
    volumes:
      - ./services/auth:/app
      - ./services/auth/keys:/keys:ro
    networks:
      - backend

  company:
    build:
      context: ./services/company
      dockerfile: Dockerfile
    container_name: company
    depends_on:
      postgres_company:
        condition: service_healthy     # <-- এখন healthcheck আছে, error আসবে না
      rabbitmq:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:01713447728@postgres_company:5432/companydb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      REDIS_URL: redis://redis:6379/1
      PUBLIC_KEY_PATH: /keys/public.pem
      DEBUG: "True"
    ports:
      - "8200:8000"
      - "8201:8001"
    volumes:
      - ./services/company:/app
      - ./services/auth/keys:/keys:ro
    # Using Daphne for both HTTP and WebSocket
    command: bash -c "python manage.py migrate --noinput && daphne -b 0.0.0.0 -p 8000 config.asgi:application"
    networks:
      - backend

  product:
    build:
      context: ./services/product
      dockerfile: Dockerfile
    container_name: dynamicpos-product
    depends_on:
      postgres_product:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:01713447728@postgres_product:5432/productdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      REDIS_URL: redis://redis:6379/2
      PUBLIC_KEY_PATH: /keys/public.pem
      DEBUG: "True"
    ports:
      - "8300:8000"
    volumes:
      - ./services/product:/app
      - ./services/auth/keys:/keys:ro
    command: bash -c "python manage.py migrate --noinput && gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3"
    networks:
      - backend

  postgres_pos:
    image: postgres:15
    container_name: dynamicpos-postgres-pos
    environment:
      POSTGRES_DB: posdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
      - "5440:5432"
    volumes:
      - pgdata_pos:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d posdb"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - backend

  pos:
    build:
      context: ./services/pos
      dockerfile: Dockerfile
    container_name: dynamicpos-pos
    depends_on:
      postgres_pos:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:01713447728@postgres_pos:5432/posdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      REDIS_URL: redis://redis:6379/3
      PUBLIC_KEY_PATH: /keys/public.pem
      DEBUG: "True"
    ports:
      - "8400:8000"
    volumes:
      - ./services/pos:/app
      - ./services/auth/keys:/keys:ro
    command: bash -c "python manage.py migrate --noinput && gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3"
    networks:
      - backend

  postgres_inventory:
    image: postgres:15
    container_name: dynamicpos-postgres-inventory
    environment:
      POSTGRES_DB: inventorydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
      - "5441:5432"
    volumes:
      - pgdata_inventory:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d inventorydb"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - backend

  inventory:
    build:
      context: ./services/inventory
      dockerfile: Dockerfile
    container_name: dynamicpos-inventory
    depends_on:
      postgres_inventory:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:01713447728@postgres_inventory:5432/inventorydb
      PUBLIC_KEY_PATH: /keys/public.pem
      DEBUG: "True"
    ports:
      - "8500:8000"
    volumes:
      - ./services/inventory:/app
      - ./services/auth/keys:/keys:ro
    command: bash -c "python manage.py migrate --noinput && gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3"
    networks:
      - backend

  inventory-worker:
    build:
      context: ./services/inventory
      dockerfile: Dockerfile
    container_name: dynamicpos-inventory-worker
    depends_on:
      postgres_inventory:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:01713447728@postgres_inventory:5432/inventorydb
      PUBLIC_KEY_PATH: /keys/public.pem
      DEBUG: "True"
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
    volumes:
      - ./services/inventory:/app
      - ./services/auth/keys:/keys:ro
    command: python manage.py run_inventory_consumer
    networks:
      - backend

  postgres_purchase:
    image: postgres:15
    container_name: dynamicpos-postgres-purchase
    environment:
      POSTGRES_DB: purchasedb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
      - "5442:5432"
    volumes:
      - pgdata_purchase:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d purchasedb"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s
    networks:
      - backend

  purchase:
    build:
      context: ./services/purchase
      dockerfile: Dockerfile
    container_name: dynamicpos-purchase
    depends_on:
      postgres_purchase:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:01713447728@postgres_purchase:5432/purchasedb
      PUBLIC_KEY_PATH: /keys/public.pem
      DEBUG: "True"
    ports:
      - "8600:8000"
    volumes:
      - ./services/purchase:/app
      - ./services/auth/keys:/keys:ro
    command: bash -c "python manage.py migrate --noinput && gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3"
    networks:
      - backend

  purchase-worker:
    build:
      context: ./services/purchase
      dockerfile: Dockerfile
    container_name: dynamicpos-purchase-worker
    depends_on:
      postgres_purchase:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://postgres:01713447728@postgres_purchase:5432/purchasedb
      PUBLIC_KEY_PATH: /keys/public.pem
      DEBUG: "True"
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
    volumes:
      - ./services/purchase:/app
      - ./services/auth/keys:/keys:ro
    command: python manage.py run_purchase_consumer
    networks:
      - backend

  jaeger:
    image: jaegertracing/all-in-one:1.46
    container_name: dynamicpos-jaeger
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14268:14268"
      - "14250:14250"
      - "9411:9411"
    networks:
      - backend

volumes:
  pgdata_auth:
  pgdata_company:
  pgdata_product:
  pgdata_pos:
  pgdata_inventory:
  pgdata_purchase:

networks:
  backend:
    driver: bridge