services:

  # ---------- Broker / infra ----------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: dynamicpos-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "15673:15672"   # host:container (management UI remapped)
      - "5673:5672"     # host:container (AMQP remapped)
    healthcheck:
      test: ["CMD","rabbitmqctl","status"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  redis:
    image: redis:7-alpine
    container_name: dynamicpos-redis
    ports:
      - "6389:6379"     # remapped
    healthcheck:
      test: ["CMD","redis-cli","ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  # ---------- API Gateway (KONG DB-LESS) ----------
  kong:
    image: kong:3.0
    container_name: dynamicpos-kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001, 0.0.0.0:8444
      # KONG_ADMIN_LISTEN can stay as default inside container
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
    ports:
      - "8101:8000"   # proxy (host 8101 -> container 8000)
      - "8543:8443"   # proxy TLS
      - "8102:8001"   # admin (host 8102 -> container 8001)
    networks:
      - backend
    depends_on:
      - auth

  # ---------- AUTH service ----------
  postgres_auth:
    image: postgres:15
    container_name: dynamicpos-postgres-auth
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
    - "5437:5432"
    volumes:
      - pgdata_auth:/var/lib/postgresql/data
    networks:
      - backend

  auth:
    build: 
      context: ../services/auth
      dockerfile: Dockerfile
    container_name: dynamicpos-auth
    depends_on:
      - postgres_auth
      - rabbitmq
      - redis
    environment:
      SECRET_KEY: "django-insecure-nhyxu&!qdm@3-u)#$$ _6=##19f656)b0q8h!uk2p*vewo4jr7t8"
      DATABASE_URL: postgres://postgres:01713447728@postgres_auth:5432/authdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/0
      DJANGO_SUPERUSER_USERNAME: admin
      DJANGO_SUPERUSER_EMAIL: admin@example.com
      DJANGO_SUPERUSER_PASSWORD: adminpass
      ALLOWED_HOSTS: "localhost,127.0.0.1,auth"
      CSRF_TRUSTED_ORIGINS: "http://localhost:8101,http://localhost:8100"
    ports:
      - "8100:8000"
    healthcheck:
      test: ["CMD","curl","-f","http://localhost:8000/health/"]
      interval: 10s
      retries: 5
    networks:
      - backend
    volumes:
      - ../services/auth:/app             # <-- host code bind-mounted into container
      - ../services/auth/keys:/keys:ro
    env_file:
    - ../services/auth/.env
  company:
    build:
      context: ../services/company
    container_name: dynamicpos-company
    environment:
      DATABASE_URL: postgres://postgres:password@postgres_company:5432/companydb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      AMQP_EXCHANGE: events
      PUBLIC_KEY_PATH: /keys/public.pem
      JWT_ISSUER: auth-service
      JWT_AUDIENCE: pos-system
      RABBITMQ_HOST: rabbitmq
    volumes:
      - ../services/company:/app
      - ../services/auth/keys:/keys:ro
    ports:
      - "8200:8000"
    depends_on:
      - postgres_company
      - rabbitmq
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000
  postgres_company:
    image: postgres:15
    container_name: dynamicpos-postgres-company
    environment:
      POSTGRES_DB: companydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "01713447728"
    ports:
      - "5438:5432"   # host:container (use a free host port)
    volumes:
      - pgdata_company:/var/lib/postgresql/data
    networks:
      - backend

  company_consumer:
    build:
      context: ../services/company
    container_name: dynamicpos-company-consumer
    command: python manage.py runconsumer
    environment:
      DATABASE_URL: postgres://postgres:password@postgres_company:5432/companydb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      AMQP_EXCHANGE: events
      RABBITMQ_HOST: rabbitmq
    volumes:
      - ../services/company:/app
    depends_on:
      - postgres_company
      - rabbitmq
      - company

  auth_worker:
    build: ../services/auth
    container_name: dynamicpos-auth-worker
    command: celery -A config worker --loglevel=info
    depends_on:
      - auth
      - rabbitmq
      - redis
    environment:
      DATABASE_URL: postgres://auth:authpass@postgres_auth:5432/authdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/0
    networks:
      - backend
    volumes:
      - ../services/auth/keys:/keys:ro
  ws-gateway:
    build:
      context: ../services/ws-gateway
    container_name: dynamicpos-ws-gateway
    depends_on:
      - rabbitmq
      - redis
    environment:
      AMQP_URL: amqp://guest:guest@rabbitmq:5672/
      AMQP_EXCHANGE: events
      PUBLIC_KEY_PATH: /keys/public.pem
      REDIS_URL: redis://redis:6379
      AUTH_ISSUER: prod-client-kid
      ALLOW_ORIGIN: "http://localhost:3000"
    volumes:
      - ../services/auth/keys:/keys:ro    # mount public key from auth service keys
    ports:
      - "9001:9001"
    networks:
      - backend


volumes:
  pgdata_auth:
  pgdata_company:

networks:
  backend:
    driver: bridge
