version: "3.8"
services:

  # ---------- Broker / infra ----------
  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "15672:15672"
      - "5672:5672"
    healthcheck:
      test: ["CMD","rabbitmqctl","status"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD","redis-cli","ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------- API Gateway (KONG DB-LESS) ----------
  kong:
    image: kong:3.0
    environment:
      KONG_DATABASE: "off"                    # db-less
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    volumes:
      - ./infra/kong/kong.yml:/kong/kong.yml:ro
    ports:
      - "8000:8000"   # proxy
      - "8443:8443"   # proxy TLS (if configured)
      - "8001:8001"   # admin (dev only)

  # ---------- AUTH service ----------
  postgres_auth:
    image: postgres:15
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: auth
      POSTGRES_PASSWORD: authpass
    volumes:
      - pgdata_auth:/var/lib/postgresql/data

  auth:
    build: ./services/auth
    depends_on:
      - postgres_auth
      - rabbitmq
      - redis
    environment:
      DATABASE_URL: postgres://auth:authpass@postgres_auth:5432/authdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/0
      DJANGO_SUPERUSER_USERNAME: admin
      DJANGO_SUPERUSER_EMAIL: admin@example.com
      DJANGO_SUPERUSER_PASSWORD: adminpass
    ports:
      - "8001:8000"
    healthcheck:
      test: ["CMD","curl","-f","http://localhost:8000/health/"]
      interval: 10s
      retries: 5

  # ---------- PRODUCT service ----------
  postgres_product:
    image: postgres:15
    environment:
      POSTGRES_DB: productdb
      POSTGRES_USER: product
      POSTGRES_PASSWORD: productpass
    volumes:
      - pgdata_product:/var/lib/postgresql/data

  product:
    build: ./services/product
    depends_on:
      - postgres_product
      - rabbitmq
    environment:
      DATABASE_URL: postgres://product:productpass@postgres_product:5432/productdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
    healthcheck:
      test: ["CMD","curl","-f","http://localhost:8002/health/"]
    ports:
      - "8002:8000"

  # ---------- INVENTORY service (example) ----------
  postgres_inventory:
    image: postgres:15
    environment:
      POSTGRES_DB: inventorydb
      POSTGRES_USER: inventory
      POSTGRES_PASSWORD: inventorypass
    volumes:
      - pgdata_inventory:/var/lib/postgresql/data

  inventory:
    build: ./services/inventory
    depends_on:
      - postgres_inventory
      - rabbitmq
    environment:
      DATABASE_URL: postgres://inventory:inventorypass@postgres_inventory:5432/inventorydb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
    ports:
      - "8003:8000"

  # ---------- Celery workers (run per service as needed) ----------
  auth_worker:
    build: ./services/auth
    command: celery -A config worker --loglevel=info
    depends_on:
      - auth
      - rabbitmq
      - redis
    environment:
      DATABASE_URL: postgres://auth:authpass@postgres_auth:5432/authdb
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672/
      REDIS_URL: redis://redis:6379/0

volumes:
  pgdata_auth:
  pgdata_product:
  pgdata_inventory:
